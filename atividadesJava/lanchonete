from fastapi import FastAPI, HTTPException
from typing import List
from models import Produto
from database import cardapio

app = FastAPI(title="API - Lanches da Tia", version="1.0")

# 1️⃣ Listar todos os produtos disponíveis
@app.get("/produtos", response_model=List[Produto])
def listar_produtos():
    return [p for p in cardapio if p.disponivel]

# 2️⃣ Buscar um produto por ID
@app.get("/produtos/{produto_id}", response_model=Produto)
def buscar_produto(produto_id: int):
    produto = next((p for p in cardapio if p.id == produto_id), None)
    if not produto:
        raise HTTPException(status_code=404, detail="Produto não encontrado")
    return produto

# 3️⃣ Buscar produtos por categoria
@app.get("/produtos/categoria/{categoria}", response_model=List[Produto])
def produtos_por_categoria(categoria: str):
    categoria = categoria.capitalize()
    filtrados = [p for p in cardapio if p.categoria == categoria and p.disponivel]
    if not filtrados:
        raise HTTPException(status_code=404, detail="Nenhum produto encontrado nessa categoria")
    return filtrados

# 4️⃣ Adicionar novo produto
@app.post("/produtos", response_model=Produto)
def adicionar_produto(produto: Produto):
    if any(p.nome.lower() == produto.nome.lower() for p in cardapio):
        raise HTTPException(status_code=400, detail="Já existe um produto com esse nome")
    produto.id = max(p.id for p in cardapio) + 1
    produto.disponivel = True
    cardapio.append(produto)
    return produto

# 5️⃣ Atualizar produto
@app.put("/produtos/{produto_id}", response_model=Produto)
def atualizar_produto(produto_id: int, dados: Produto):
    for i, p in enumerate(cardapio):
        if p.id == produto_id:
            cardapio[i] = dados
            return dados
    raise HTTPException(status_code=404, detail="Produto não encontrado")

# 6️⃣ Deletar produto
@app.delete("/produtos/{produto_id}")
def deletar_produto(produto_id: int):
    for p in cardapio:
        if p.id == produto_id:
            cardapio.remove(p)
            return {"mensagem": "Produto removido com sucesso"}
    raise HTTPException(status_code=404, detail="Produto não encontrado")
